# Server Script (Script Type = API)
# API Method: get_last_purchase_rate
# Run as Administrator: YES

item_code = (frappe.form_dict.get("item_code") or "").strip()

if not item_code:
    frappe.response["message"] = {"rate": 0, "date": None}
else:
    last_rate = 0.0
    last_date = None

    inv = frappe.db.sql("""
        SELECT pii.rate, pi.posting_date
        FROM `tabPurchase Invoice Item` pii
        JOIN `tabPurchase Invoice` pi ON pi.name = pii.parent
        WHERE pii.item_code = %s AND pi.docstatus = 1
        ORDER BY pi.posting_date DESC, pii.creation DESC
        LIMIT 1
    """, (item_code,), as_dict=1)

    po = frappe.db.sql("""
        SELECT poi.rate, po.transaction_date as posting_date
        FROM `tabPurchase Order Item` poi
        JOIN `tabPurchase Order` po ON po.name = poi.parent
        WHERE poi.item_code = %s AND po.docstatus = 1
        ORDER BY po.transaction_date DESC, poi.creation DESC
        LIMIT 1
    """, (item_code,), as_dict=1)

    if inv and po:
        try:
            if (inv[0].get("posting_date") or "") >= (po[0].get("posting_date") or ""):
                last_rate = inv[0]["rate"]
                last_date = inv[0]["posting_date"]
            else:
                last_rate = po[0]["rate"]
                last_date = po[0]["posting_date"]
        except Exception:
            last_rate = inv[0]["rate"] or po[0]["rate"]
            last_date = inv[0].get("posting_date") or po[0].get("posting_date")
    elif inv:
        last_rate = inv[0]["rate"]
        last_date = inv[0]["posting_date"]
    elif po:
        last_rate = po[0]["rate"]
        last_date = po[0]["posting_date"]

    frappe.response["message"] = {
        "rate": float(last_rate or 0),
        "date": str(last_date) if last_date else None
    }
